---
- hosts: localhost
  gather_facts: false
  tasks:
    - name: Grab token using OAuth
      ansible.builtin.uri:
        url: "{{ SN_HOST }}/oauth_token.do"
        method: POST
        body_format: form-urlencoded
        return_content: true
        body:
          grant_type : password
          client_id : "{{ SN_CLIENT_ID }}"
          client_secret : "{{ SN_CLIENT_SECERT }}"
          username : "{{ SN_USERNAME }}"
          password : "{{ SN_PASSWORD }}"
      register: oauth_return_token

    - name: Ansible CMDB modification for CPU
      ansible.builtin.uri:
        url: "{{ SN_HOST }}/api/now/identifyreconcile?sysparm_data_source=Ansible"
        method: POST
        headers:
          Content-Type : application/json
          Accept : application/json
          Authorization : "Bearer {{ oauth_return_token.json.access_token }}"
        body_format: json
        body:
          items:
            - className: cmdb_ci_win_server
              values:
                name: "{{ VM_servername }}"
                cpu_core_count: "{{ CPU_Core_after }}"
                cpu_count: '1'
                
                
    - name: Ansible CMDB modification for Memory
      ansible.builtin.uri:
        url: "{{ SN_HOST }}/api/now/identifyreconcile?sysparm_data_source=Ansible"
        method: POST
        headers:
          Content-Type : application/json
          Accept : application/json
          Authorization : "Bearer {{ oauth_return_token.json.access_token }}"
        body_format: json
        body:
          items:
            - className: cmdb_ci_win_server
              values:
                name: "{{ VM_servername }}"
                ram: "{{ Mem_size_after_MB }}"
      when: catalog_item == 'Memory'
        
     
