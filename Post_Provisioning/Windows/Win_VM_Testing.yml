---
- name: Testing playbook
  hosts: localhost
  gather_facts: no
  tasks:

    - name: Look up the VM inventory
      register: search_result
      vmware.vmware_rest.vcenter_vm_info:
        filter_names:
        - "{{ variables.server }}"

    # - name: Power off the VM
    #   vmware_guest_powerstate:
    #     name: "{{ variables.server }}"
    #     state: powered-off
    #   ignore_errors: yes

 
    - name: Power off virtual machine
      vmware.vmware_rest.vcenter_vm_power:
        state: stop
  #      vm: '{{ search_result.value[0].vm }}'
        vm: '{{ variables.server }}'
        
    - name: Wait until virtual machine offline
      vmware.vmware_rest.vcenter_vm_tools_info:
        vm: '{{ variables.server }}'
      register: vm_tools_info
      until:
      - vm_tools_info is not failed
      - vm_tools_info.value.run_state == "NOT_RUNNING"
      retries: 60
      delay: 5

    # - name: Power on the VM
    #   vmware_guest_powerstate:
    #     name: "{{ variables.server }}"
    #      state: powered-on
    
    # - name: Collect information about a specific VM
    #   vmware.vmware_rest.vcenter_vm_info:
    #      vm: '{{ search_result.value[0].vm }}'
    #   register: win_vm_info
      
  
