---
- name: Get Vcenter vm details
  hosts: localhost
  gather_facts: false

  tasks:
  - name: Extract datacenter name
    set_fact:
      Vcenter_Name: "{{ hostvars[variables.server | upper]['tag_category']['vcenter'] | first }}"

  - name: display info
    debug: 
      msg: "{{ Vcenter_Name }}"

  - name: Gather all registered virtual machines
    community.vmware.vmware_vm_info:
      hostname: '{{ Vcenter_Name }}'
      username: '{{ VMWARE_USERNAME }}'
      password: '{{ VMWARE_PASSWORD }}'
      validate_certs: false
    register: all_servers

  # - name: Display all VM guest names
  #   debug:
  #       msg: "{{ all_servers.virtual_machines | map(attribute='guest_name') | list }}"

  # - name: Display all VM guest names in lowercase
  #   debug:
  #      msg: "{{ all_servers.virtual_machines | map(attribute='guest_name') | map('lower') | list }}"
  - name: Initialize an empty list for vm_guest_names
    set_fact:
      vm_guest_names: []

  - name: Populate the list with guest names and their lowercase versions
    set_fact:
      vm_guest_names: "{{ vm_guest_names | default([]) + [{'guest_name_lower': item.lower(), 'guest_name': item}] }}"
      loop: "{{ all_servers.virtual_machines | map(attribute='guest_name') | list }}"

  - name: Find and set the actual guest name for a given host_name
    set_fact:
      actual_guest_name: "{{ (vm_guest_names | selectattr('guest_name_lower', 'equalto', variables.server) | map(attribute='guest_name') | first) | default('Not Found') }}"

  - name: Display the actual guest name
    debug:
      msg: "The actual guest name for '{{ variables.server }}' is '{{ actual_guest_name }}'"

  # - name: Populate the list with guest names and their lowercase versions
  #   set_fact:
  #     vm_guest_names: >
  #       {{
  #         vm_guest_names + [
  #           {
  #             'guest_name_lower': item | lower,
  #             'guest_name': all_servers.virtual_machines[loop.index].guest_name
  #           }
  #           for item in all_servers.virtual_machines | map(attribute='guest_name')
  #         ]
  #       }}
  #   loop_control:
  #     loop_var: item
  #   with_items: "{{ all_servers.virtual_machines | map(attribute='guest_name') | list }}"
  
  # - name: Create a list with guest names and their lowercase versions
  #   set_fact:
  #     vm_guest_names: >
  #       {{
  #         all_servers.virtual_machines | 
  #         map(attribute='guest_name') | 
  #         map('lower') | 
  #         zip(all_servers.virtual_machines | map(attribute='guest_name')) | 
  #         map('community.general.dict', guest_name_lower='first', guest_name='second') |
  #         list
  #       }}
      
  # - name: Find and set the actual guest name for a given host_name
  #   set_fact:
  #     actual_guest_name: >
  #       {{
  #         (vm_guest_names | 
  #         selectattr('guest_name_lower', 'equalto', variables.server) | 
  #         map(attribute='guest_name') | 
  #         first) | 
  #         default('Not Found')
  #       }}

  # - name: Display the actual guest name
  #   debug:
  #     msg: "The actual guest name for '{{ variables.server }}' is '{{ actual_guest_name }}'"

  # - name: Manually filter servers case-insensitively
  #   set_fact:
  #       matched_servers: >-
  #         {{
  #           all_servers.virtual_machines |
  #           selectattr('guest_name', 'defined') |
  #           selectattr('guest_name', 'search', variables.server | lower) |
  #           map(attribute='guest_name') |
  #           list
  #         }}

  # - name: Display matched servers
  #   debug:
  #     msg: "{{ matched_servers }}"

  # - name: Reboot the virtual machine
  #   community.vmware.vmware_guest_powerstate:
  #      hostname: '{{ Vcenter_Name }}'
  #      username: '{{ VMWARE_USERNAME }}'
  #      password: '{{ VMWARE_PASSWORD }}'
  #      validate_certs: false
  #      name: "{{ server_name }}"
  #      state: reboot-guest
  
