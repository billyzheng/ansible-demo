---
- name: Get Vcenter
  hosts: localhost
  gather_facts: false

  tasks:
  - name: Extract datacenter name
    set_fact:
      datacenter_name: "{{ hostvars[server_name]['tag_category']['vcenter'] }}"

  - name: Get the VM inventory - before changes
    vmware.vmware_rest.vcenter_vm_info:
      vcenter_hostname: "{{ datacenter_name }}"
      vcenter_username: "{{ VMWARE_USERNAME }}"
      vcenter_password: "{{ VMWARE_PASSWORD }}" 
      filter_names: 
      - "{{ server_name }}"
    register: vm_fact
      
