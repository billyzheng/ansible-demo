---
- name: Get current DNS suffix search list
  ansible.windows.win_shell: Get-DnsClientGlobalSetting | Select-Object -ExpandProperty SuffixSearchList
  register: current_suffix

- debug:
    var: current_suffix

- name: Parse DNS suffixes
  set_fact:
    dns_suffixes_list: "{{ dns_suffixes.splitlines() }}"

- name: Run PowerShell script to validate DNS suffix
  ansible.windows.win_shell: |
       Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass
       $DNSSuffix = "{{ dns_suffixes_list }}"
       $suffixresult = "{{ current_suffix.stdout }}"
       foreach ($dns_suffix in $DNSSuffix) {
           $suffixes = $suffixresult -split "\r?\n"
           if ($dns_suffix -notin $suffixes) {
               $cmd = "Add-DnsClientGlobalSetting -SuffixSearchList $dns_suffix"
               Invoke-Expression $cmd
           }
       }
       Get-DnsClientGlobalSetting | Select-Object -ExpandProperty SuffixSearchList
  register: script_output

- debug:
    msg: "{{ script_output.stdout }}"
